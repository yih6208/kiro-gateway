version: '3.8'

services:
  kiro-gateway:
    # 使用預先構建的 image（不需要源代碼）
    image: kiro-gateway_kiro-gateway:latest
    container_name: kiro-gateway
    ports:
      - "8001:8000"
    environment:
      # 使用 kiro-cli 數據庫
      - KIRO_CLI_DB_FILE=/root/.local/share/kiro-cli/data.sqlite3
      # 設置代理 API 密鑰（可以在 .env 文件中覆蓋）
      - PROXY_API_KEY=${PROXY_API_KEY:-my-super-secret-password-123}
      # kiro-cli 登入參數（可以在 .env 文件中覆蓋）
      - KIRO_START_URL=${KIRO_START_URL:-https://amzn.awsapps.com/start}
      - KIRO_LOGIN_REGION=${KIRO_LOGIN_REGION:-us-east-1}
      - KIRO_LICENSE=${KIRO_LICENSE:-pro}
    volumes:
      # 持久化 kiro-cli 憑證數據（重要！避免每次重啟都要重新登入）
      - kiro-cli-data:/root/.local/share/kiro-cli
      # 持久化 debug 日誌
      - ./debug_logs:/app/debug_logs
    restart: unless-stopped
    # 支持互動式終端（用於 kiro-cli login）
    stdin_open: true
    tty: true
    # 資源限制
    deploy:
      resources:
        limits:
          cpus: '1.0'      # 最多使用 1 個 CPU 核心
          memory: 1G       # 最多使用 1GB 記憶體
        reservations:
          cpus: '0.25'     # 保留 0.25 個 CPU 核心
          memory: 256M     # 保留 256MB 記憶體
    # 日誌配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  # 持久化 kiro-cli 數據
  kiro-cli-data:
    driver: local
