version: '3.8'

services:
  kiro-gateway:
    # 使用預先構建的 image（不需要源代碼）
    image: kiro-gateway_kiro-gateway:latest
    container_name: kiro-gateway
    network_mode: bridge
    ports:
      - "8001:8000"
    # 從 .env 文件加載環境變數
    env_file:
      - ../.env
    environment:
      # 使用 kiro-cli 數據庫（容器內路徑）
      - KIRO_CLI_DB_FILE=/root/.local/share/kiro-cli/data.sqlite3
      # 以下變數可以在 .env 文件中配置，這裡提供默認值
      - PROXY_API_KEY=${PROXY_API_KEY:-TimLiHomeServer}
      - KIRO_START_URL=${KIRO_START_URL:-https://amzn.awsapps.com/start}
      - KIRO_LOGIN_REGION=${KIRO_LOGIN_REGION:-us-east-1}
      - KIRO_LICENSE=${KIRO_LICENSE:-pro}
      - DEBUG_MODE=${DEBUG_MODE:-errors}
      # HTTP 連接池設置（從 .env 加載，這裡提供默認值）
      - HTTP_MAX_CONNECTIONS=${HTTP_MAX_CONNECTIONS:-300}
      - HTTP_MAX_KEEPALIVE_CONNECTIONS=${HTTP_MAX_KEEPALIVE_CONNECTIONS:-150}
      - HTTP_KEEPALIVE_EXPIRY=${HTTP_KEEPALIVE_EXPIRY:-60.0}
      - HTTP_POOL_TIMEOUT=${HTTP_POOL_TIMEOUT:-none}
    volumes:
      # 持久化 kiro-cli 憑證數據（重要！避免每次重啟都要重新登入）
      - kiro-cli-data:/root/.local/share/kiro-cli
      # 持久化 debug 日誌
      - ../debug_logs:/app/debug_logs
    restart: unless-stopped
    # 支持互動式終端（用於 kiro-cli login）
    stdin_open: true
    tty: true
    # 資源限制（調整為 2 核心 / 512MB）
    deploy:
      resources:
        limits:
          cpus: '2.0'      # 最多使用 2 個 CPU 核心
          memory: 512M     # 最多使用 512MB 記憶體
        reservations:
          cpus: '0.5'      # 保留 0.5 個 CPU 核心
          memory: 256M     # 保留 256MB 記憶體
    # 日誌配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  # 持久化 kiro-cli 數據
  kiro-cli-data:
    driver: local
